<!DOCTYPE html>
<html>
  <head>

  </head>
  <body>
    <h2>Company: <span id="company"></span></h2>
    <p>Total Actions: <span id="actions">0</span></p>
    <p>Mammograms booked: <span id="mammograms">0</span></p>
    <p>Self-exams performed: <span id="self-exams">0</span></p>
    <p>Have the early detection app: <span id="early-detection">0</span></p>
    <p>Stories shared: <span id="stories">0</span></p>

    <div>
      <p>Top 5 Scorers:</p>

      <ul id="top-5">
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </div>

    <div>
      <p>Top 3 Units:</p>

      <ul id="units">
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </div>

    <div>
      <p>Company Leaderboard:</p>

      <ul id="company-leaderboard">
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <script>
      const company = document.querySelector('#company')
      const actions = document.querySelector('#actions')
      const mammograms = document.querySelector('#mammograms')
      const selfExams = document.querySelector('#self-exams')
      const earlyDetection = document.querySelector('#early-detection')
      const stories = document.querySelector('#stories')
      const top5s = document.querySelectorAll('#top-5 li')
      const units = document.querySelectorAll('#units li')
      const companyLeaderboard = document.querySelectorAll('#company-leaderboard li')

      const mammomgramIndex = 8
      const selfExamsIndex = 6
      const earlyDetectionIndex = 10
      const storiesIndex = 11
      const firstNameIndex = 2
      const lastNameIndex = 3
      const unitsIndex = 1

      let actionsTotal = 0
      let mammomgramTotal = 0
      let selfExamsTotal = 0
      let earlyDetectionTotal = 0
      let storiesTotal = 0

      const timeline = gsap.timeline()

      const url = 'https://sheets.googleapis.com/v4/spreadsheets';
      const sheet = '1NQtTs2ZIxBSopOxug0-b5dIrX662-v0NO9WT-e1Pkzs';
      const key = 'AIzaSyCBIz_Y8mbGuQXSR3elO3d5KZrYiejBM6s';
      const sheetName = 'KYL@Work Points'

      const array = {};
      fetch(`${url}/${sheet}/values/${sheetName}!A1:Z500?key=${key}`)
        .then(resp => resp.json())
        .then((data) => {
          const { values } = data

          const newValues = values.slice(1, values.length - 1)

          newValues.forEach(value => {
            if (value.length && value[0]) {
              const company = value[0]
              if (!array[company]) {
                array[company] = []
              }

              array[company].push(value)
            }
          })

          company.innerHTML = Object.keys(array)[0]
          const currentItemValues = Object.values(array)[0]

          actionsTotal = currentItemValues.reduce((sum, item) =>
            sum + Number(item[mammomgramIndex]) +
                  Number(item[selfExamsIndex]) +
                  Number(item[earlyDetectionIndex]) +
                  (item[storiesIndex] === 'Yes' ? 1 : 0)
          , 0)

          mammomgramTotal = currentItemValues.reduce((sum, a) => sum + Number(a[mammomgramIndex]), 0)

          selfExamsTotal = currentItemValues.reduce((sum, a) =>
          sum + Number(a[selfExamsIndex]), 0)

          earlyDetectionTotal = currentItemValues.reduce((sum, a) =>
          sum + Number(a[earlyDetectionIndex]), 0)

          storiesTotal = currentItemValues.reduce((sum, a) => {
            const val = a[storiesIndex] === 'Yes' ? 1 : 0
            return sum + val
          }, 0)

          const totalScores = currentItemValues.map((item, index) => {
            return {
              index,
              value: Number(item[mammomgramIndex]) +
                      Number(item[selfExamsIndex]) +
                      Number(item[earlyDetectionIndex]) +
                      (item[storiesIndex] === 'Yes' ? 1 : 0),
              firstName: item[firstNameIndex],
              lastName: item[lastNameIndex],
              name: `${item[firstNameIndex]} ${item[lastNameIndex]}`,
              unit: item[unitsIndex]
            }
          })

          getTopScorers(currentItemValues, totalScores)
          getTopUnits(currentItemValues, totalScores)
          getCompanyLeaderboard(array)

          animate(actions, actionsTotal)
          animate(mammograms, mammomgramTotal)
          animate(selfExams, selfExamsTotal)
          animate(earlyDetection, earlyDetectionTotal)
          animate(stories, storiesTotal)
        })

        function animate(property, total, delay) {
          const obj = { val: 0 }
          timeline.to(obj, {
            val: total,
            duration: .75,
            ease: 'power2.inOut',
            onUpdate: () => property.innerHTML = Math.round(obj.val)
          }, '-=.5')
        }

        function getTopUnits (items, totalScores) {
          const groupByUnit = totalScores.reduce((group, product) => {
            const { unit } = product
            group[unit] = group[unit] ?? []
            group[unit].push(product)
            return group
          }, {})

          const combinedScores = []
          for (const key in groupByUnit) {
            if (Object.hasOwnProperty.call(groupByUnit, key)) {
              let total = 0
              const element = groupByUnit[key];
              element.forEach(el => {
                total += el.value
              });

              combinedScores.push({
                index: element[0].index,
                value: total,
                firstName: element[0].firstName,
                lastName: element[0].lastName,
                name: element[0].name,
                unit: element[0].unit
              })
            }
          }

          combinedScores.sort((a, b) => b.value - a.value || b.unit < a.unit)

          combinedScores.forEach((score, index) => {
            if (index <= 3) {
              const lineItem = items[combinedScores[index].index]

              if (units[index]) {
                units[index].innerHTML = `${lineItem[unitsIndex]}: ${score.value}`
              }
            }
          })
        }

        function getTopScorers (items, totalScores) {
          const groupByName = totalScores.reduce((group, product) => {
            const { name } = product
            group[name] = group[name] ?? []
            group[name].push(product)
            return group
          }, {})

          const combinedScores = []
          for (const key in groupByName) {
            if (Object.hasOwnProperty.call(groupByName, key)) {
              let total = 0
              const element = groupByName[key];
              element.forEach(el => {
                total += el.value
              });

              combinedScores.push({
                index: element[0].index,
                value: total,
                firstName: element[0].firstName,
                lastName: element[0].lastName,
                name: element[0].name
              })
            }
          }

          combinedScores.sort((a, b) => b.value - a.value || b.lastName < a.lastName)

          combinedScores.forEach((score, index) => {
            if (index <= 5) {
              const lineItem = items[combinedScores[index].index]

              if (top5s[index]) {
                top5s[index].innerHTML = `${lineItem[firstNameIndex]} ${lineItem[lastNameIndex].slice(0, 1)}: ${score.value}`
              }
            }
          })
        }

        function getCompanyLeaderboard (array) {
          const companies = []
          for (const key in array) {
            if (Object.hasOwnProperty.call(array, key)) {
              const element = array[key];
              const total = element.reduce((sum, item) =>
                sum + Number(item[mammomgramIndex]) +
                      Number(item[selfExamsIndex]) +
                      Number(item[earlyDetectionIndex]) +
                      (item[storiesIndex] === 'Yes' ? 1 : 0)
              , 0)

              companies.push({ company: key, total })
            }
          }

          companies.sort((a, b) => b.total - a.total || b.company < a.company)

          companyLeaderboard.forEach((company, index) => {
            company.innerHTML = `${companies[index].company}: ${companies[index].total}`
          })
        }

    </script>
  </body>
</html>